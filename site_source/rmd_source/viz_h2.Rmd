---
title: "Vizualising $h^2_g$ and intercept results"
date: "Last updated `r format(Sys.Date())`"
author: "Results from the [Neale Lab](credits.html)"
output: 
  html_document:
    toc: true
    toc_float: true
params:
  datfile: "../results/round2_final/ukb31063_h2_topline.02Oct2019.tsv.gz"
---

```{r child = '_toc_fix.Rmd'}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(reshape2)
require(ggplot2)
require(plotly)
require(DT)
require(crosstalk)
require(crosstool)
require(Rmpfr)

# handle params
dat <- read.delim(file=normalizePath(params$datfile),sep='\t',header=T,stringsAsFactors=F,colClasses=c(intercept_p="character"))

# setup
dat <- dat[dat$confidence != "none",]

```

```{r smallp_func, include=FALSE}

# handle intercept_p as a string (due to high precision p-vals)
pstring <- function(p, prec=3){

intp_string <- as.character(p)
intp_string[p == as.character(as.numeric(p))] <- as.character(signif(as.numeric(p),prec)[(p == as.character(as.numeric(p)))])
highstr <- intp_string[!(p == as.character(as.numeric(p)))]
highstr_lead <- as.character(signif(as.numeric(substr(highstr,1,6)),prec))
highstr_exp <- sapply(highstr,function(a) strsplit(a,split="e")[[1]][2],USE.NAMES = F)
intp_string[!(p == as.character(as.numeric(p)))] <- paste0(highstr_lead,"e",highstr_exp)
while(any(intp_string=="1")){
  prec <- prec+1
  intp_string[intp_string=="1"] <- as.character(signif(as.numeric(p),prec)[intp_string=="1"])
}
return(intp_string)
}


datintercept_p <- pstring(dat$intercept_p)
dat$int_nlogp <- as.numeric(-log10(mpfr(0.5,64)*erfc(mpfr(dat$intercept_z,64)/sqrt(mpfr(2,64)))))

```

<br>

### Overview

<br>

### SNP Heritability {.tabset .tabset-fade}

#### $h^2_g$ Estimates

<div class="well">

```{r hist_h2, echo=FALSE}
d2 <- SharedData$new(dat)

pp <- plot_ly(d2) %>%
        add_histogram(
			    x = ~h2_liability,
			    histnorm = "probability",
			    hoverinfo="none"
	  		)
  
  
bscols(widths=c(10,2),
	config(pp, collaborate = F, showLink=F, displayModeBar=F, displaylogo=F, sendData=F),
	list(
		filter_slider("Neff", "Effective N", d2, ~Neff, step=100, width="100%"),
		filter_select("variable_type","Var. Type", d2, ~variable_type, multiple=T),
		filter_select("confidence","Confidence", d2, ~confidence, multiple=T),
		filter_select("significance","h2 Significance", d2, ~h2_sig, multiple=T),
		filter_select("source","Dataset", d2, ~source, multiple=T)
	)
)
```

</div>

<br>

#### $h^2_g$ p-values

<div class="well">
  
```{r qq_h2, echo=FALSE}

shared_h2_3 <- SharedData$new(dat)

exp_nlogp <- function(p){
  nn <- length(p)
  qquad <- 1:nn
  qref <- (qquad-.5)/nn
  idx <- rank(p)
  return(-log10(qref[idx]))
}

nnr <- nrow(dat[dat$confidence != "none",])
qquad <-c(1:nnr)
qref <- ((qquad-.5)/nnr)
ci_up <- qbeta(.975,qquad,nnr+1-qquad)
ci_lo <- qbeta(.025,qquad,nnr+1-qquad)

pp <- plot_ly(shared_h2_3, 
              x=~exp_nlogp(h2_p), 
              y=~(-log10(h2_p)),
              type="scatter",
              mode="markers",
              showlegend=F,
              hoverinfo="text",
              text = ~paste0(
                "Phenotype: ", description,
                "<br>SNP h2: ", round(h2_liability,5), " (p=",signif(h2_p, 3),")",
                "<br>Intercept: ", round(intercept,5), " (p=",intercept_p,")",                
                "<br>Effective N: ", Neff)
) %>% add_trace(
  x=-log10(qref),
  y=-log10(qref),
  mode="lines",
  showlegend=F,
  hoverinfo = "text",
  text = ""
) %>% add_trace(
  x=-log10(qref),
  y=-log10(ci_up),
  mode="lines",
  line=list(color='#2ca02c'),
  showlegend=F,
  hoverinfo = "text",
  text = ""
) %>% add_trace(
  x=-log10(qref),
  y=-log10(ci_lo),
  mode="lines",
  line=list(color='#2ca02c'),
  fill="tonexty",
  fillcolor='rgba(44,160,44,0.2)',
  showlegend=F,
  hoverinfo = "text",
  text = ""
) %>% layout(
  showlegend=T,
  xaxis = list(title="Expected -log10(p-value)"),
  yaxis = list(title="Observed -log10(p-value)")
)

bscols(widths=c(12),
       config(pp, collaborate = F, showLink=F, displayModeBar=F, displaylogo=F, sendData=F)
)
```

<p></p>

*Note:* Comparison limited to phenotypes with at least some [confidence](confidence.html) in the Round 2 results.

</div>

<br>

#### $h^2_g$ by Confidence

<div class="well">

```{r hist_h2_conf, echo=FALSE}
d2 <- SharedData$new(dat)

pp <- plot_ly(d2, alpha=0.6) %>%
        add_histogram(
			    x = ~h2_liability,
			    histnorm = "probability",
			    split=~confidence
	  		) %>%
      layout(barmode="overlay")
  
  
bscols(widths=c(10,2),
	config(pp, collaborate = F, showLink=F, displayModeBar=F, displaylogo=F, sendData=F),
	list(
		filter_slider("Neff", "Effective N", d2, ~Neff, step=100, width="100%"),
		filter_select("variable_type","Var. Type", d2, ~variable_type, multiple=T),
		filter_select("confidence","Confidence", d2, ~confidence, multiple=T),
		filter_select("significance","h2 Significance", d2, ~h2_sig, multiple=T),
		filter_select("source","Dataset", d2, ~source, multiple=T)
	)
)
```

</div>

<br>

#### p-values by Confidence

<div class="well">
  
```{r qq_h2_conf, echo=FALSE}

exp_nlogp <- function(p){
  nn <- length(p)
  qquad <- 1:nn
  qref <- (qquad-.5)/nn
  idx <- rank(p)
  return(-log10(qref[idx]))
}

nnr <- nrow(dat[dat$confidence != "none",])
qquad <-c(1:nnr)
qref <- ((qquad-.5)/nnr)
ci_up <- qbeta(.975,qquad,nnr+1-qquad)
ci_lo <- qbeta(.025,qquad,nnr+1-qquad)

pp <- plot_ly(dat) %>%
        add_trace(
              data=dat[dat$confidence=="high",],
              x=~exp_nlogp(h2_p), 
              y=~(-log10(h2_p)),
              name="High Confidence",
              type="scatter",
              mode="markers",
              hoverinfo="text",
              text = ~paste0(
                "Phenotype: ", description,
                "<br>SNP h2: ", round(h2_liability,5), " (p=",signif(h2_p, 3),")",
                "<br>Intercept: ", round(intercept,5), " (p=",intercept_p,")",                
                "<br>Effective N: ", Neff)
) %>% add_trace(
              data=dat[dat$confidence=="medium",],
              x=~exp_nlogp(h2_p), 
              y=~(-log10(h2_p)),
              name="Medium Confidence",
              type="scatter",
              mode="markers",
              hoverinfo="text",
              text = ~paste0(
                "Phenotype: ", description,
                "<br>SNP h2: ", round(h2_liability,5), " (p=",signif(h2_p, 3),")",
                "<br>Intercept: ", round(intercept,5), " (p=",intercept_p,")",                
                "<br>Effective N: ", Neff)
) %>% add_trace(
              data=dat[dat$confidence=="low",],
              x=~exp_nlogp(h2_p), 
              y=~(-log10(h2_p)),
              name="Low Confidence",
              type="scatter",
              mode="markers",
              hoverinfo="text",
              text = ~paste0(
                "Phenotype: ", description,
                "<br>SNP h2: ", round(h2_liability,5), " (p=",signif(h2_p, 3),")",
                "<br>Intercept: ", round(intercept,5), " (p=",intercept_p,")",                
                "<br>Effective N: ", Neff)
) %>% add_trace(
		x=-log10(qref),
		y=-log10(qref),
		type="scatter",
		mode="lines",
		line=list(color='rgba(0,0,0,0.8)'),
		showlegend=F,
		hoverinfo = "text",
		text = ""
) %>% add_trace(
		x=-log10(qref),
		y=-log10(ci_up),
		type="scatter",
		mode="lines",
		line=list(color='rgba(0,0,0,0.3)'),
		showlegend=F,
		hoverinfo = "text",
		text = ""
) %>% add_trace(
		x=-log10(qref),
		y=-log10(ci_lo),
		type="scatter",
		mode="lines",
		line=list(color='rgba(0,0,0,0.3)'),
		fill="tonexty",
		fillcolor='rgba(0,0,0,0.2)',
		showlegend=F,
		hoverinfo = "text",
		text = ""
) %>% layout(
  showlegend=T,
  xaxis = list(title="Expected -log10(p-value)"),
  yaxis = list(title="Observed -log10(p-value)")
)

bscols(widths=c(12),
       config(pp, collaborate = F, showLink=F, displayModeBar=F, displaylogo=F, sendData=F)
)
```

<p></p>

*Note:* Comparison limited to phenotypes with at least some [confidence](confidence.html) in the Round 2 results.

</div>

<br>

### LDSR Intercept {.tabset .tabset-fade}

#### Ratio Estimates

#### Intercept Estimates

#### Intercept p-values

### SNP Heritablity vs. Intercept {.tabset .tabset-fade}

#### Estimates

#### Z scores

#### $h^2_g$ vs. Ratio



